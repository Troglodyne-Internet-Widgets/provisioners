# Backups in Provisioners

We use a standardized approach to handling data persistence and backups across deployments through the `remote_files` subroutine in provisioner recipes.

## How It Works

Each recipe that needs to persist data between deployments implements a `remote_files` subroutine that returns a hash mapping source paths on the remote server to local storage paths in the provisioner's data directory.

Example:

```perl
sub remote_files {
    return (
        '/path/on/remote/server/file.db'     => 'local/data/file.db',
        '/path/on/remote/server/config.yaml' => 'local/config/config.yaml',
        '/path/on/remote/server/data/'       => 'local/datadir/'
    );
}
```

You can back up either files or directories via this mechanism.
Each time you run `bin/new_config`, they will be fetched from the running host so you don't have to start from scratch.
The recipe can then move these backed-up items from the `install_dir` into wherever they ought to be on the guest.

# What ought to be backed up

In general if it's not being generated by this tool, but by the application being provisioned it should be backed up.
If config changes matter they ought to be implemented either as a new recipe or as configuration in recipes.yaml.

# Incremental, offsite and on-going backups

If you setup the host to use the `backup` recipe, and another host to have the `backupdestination` recipe aimed at it, this implements incremental backups for you.
This uses both rsync's `--link-dir` functionality to minimize disk usage per checkpoint and rsyncd via ssh authorized keys command as root for secure access while being able to access everything necessary.
The idea is that you can rsync over a checkpoint into a datadir and just re-provision the host to solve your data loss problem.
